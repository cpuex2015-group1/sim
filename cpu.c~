#include<stdio.h>
#include<stdint.h>
#include"cpu.h"

uint32_t pc=0;

int32_t gpr[GPR_NUM]={};
uint32_t fpr[FPR_NUM]={};

uint32_t memory[MEM_NUM]={};

void decode(uint32_t inst,uint32_t *opcode,uint32_t *rs,uint32_t *rt,uint32_t *rd,uint32_t *shamt,uint32_t *funct,int16_t *imm,uint32_t *addr)
{
  *opcode=inst>>26;
  *rs=(inst>>21)&0x1f;
  *rt=(inst>>16)&0x1f;
  *rd=(inst>>11)&0x1f;
  *shamt=(inst>>6)&0x1f;
  *funct=inst&0x3f;
  *imm=inst&0xffff;
  *addr=inst&0x3ffffff;
}

void exec_inst(uint32_t inst)
{
  uint32_t opcode,rs,rt,rd,shamt,funct,addr;
  int16_t imm;

  decode(inst,&opcode,&rs,&rt,&rd,&shamt,&funct,&imm,&addr);

  printf("%d %d %d\n",opcode,rs,imm);

  switch (opcode) {
  case OP_NOP:
    break;
  case OP_ADD:
    gpr[rd]=gpr[rs]+gpr[rt];
    break;
  case OP_ADDI:
    gpr[rt]=gpr[rs]+imm;
    break;
  case OP_SUB:
    gpr[rd]=gpr[rs]-gpr[rt];
    break;
  case OP_SUBI:
    gpr[rt]=gpr[rs]-imm;
    break;
  case OP_BEQ:
    if (gpr[rs]==gpr[rt]) {
      pc=addr;
    }
    break;
  case OP_ST:
    memory[gpr[rs]]=gpr[rt]
    break;
  case OP_LD:
    gpr[rt]=memory[gpr[rs]];
    break;
  case OP_JR:
    break;
  case OP_JAL:
    break;
  case OP_SEND:
    printf("send %2d : &d\n",rs,gpr[rs]);
    break;
  case OP_HALT:
    break;
  case OP_SLL:
    gpr[rd]=gpr[rt]<<shamt;
    break;
  case OP_SRL:
    gpr[rd]=gpr[rt]>>shamt;
    break;
  case OP_FADD:
    break;
  case OP_FMUL:
    break;
  case OP_FINV:
    break;
  case OP_FABS:
    break;
  case OP_FNEG:
    break;
  case OP_FCMP:
    break;
  default:
    printf("Unknown instruction\n");
    break;
  }
}
